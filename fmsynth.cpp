/*****************************************************************************
 * fmsynth.cpp - Ad Lib Gold FM synth miniport implementation.
 *****************************************************************************
 *
 * OPL3 (YMF262) FM synthesis MIDI miniport.  Adapted from the Windows 2000
 * DDK fmsynth sample driver (miniport.cpp).
 *
 * Key adaptation: all OPL3 register writes are routed through
 * IAdapterCommon::WriteOPL3() instead of direct port I/O, so the Ad Lib
 * Gold's bank switching between OPL3 array 1 and the Control Chip is
 * handled transparently.
 *
 * Copyright (c) 1996-1999 Microsoft Corporation.  All rights reserved.
 * Adapted for Ad Lib Gold, 2026.
 */

#include "fmsynth.h"

#define STR_MODULENAME "AdLibGoldFM: "


/*****************************************************************************
 * Velocity attenuation lookup table
 * Converts linear MIDI velocity to logarithmic attenuation.
 */
static BYTE gbVelocityAtten[64] = {
        40, 37, 35, 33, 31, 29, 27, 25, 24, 22, 21, 20, 19, 18, 17, 16,
        16, 15, 14, 14, 13, 13, 12, 12, 11, 11, 10, 10, 9,  9,  8,  8,
        7,  7,  6,  6,  6,  5,  5,  5,  4,  4,  4,  4,  3,  3,  3,  3,
        2,  2,  2,  2,  2,  1,  1,  1,  1,  1,  0,  0,  0,  0,  0,  0 };

/*****************************************************************************
 * Percussion instrument map
 * Maps GM drum notes (35-87) to patch/note pairs.
 */
static BYTE gbPercMap[53][2] =
{
   {  0, 35 },
   {  0, 35 },
   {  2, 52 },
   {  3, 48 },
   {  4, 58 },
   {  5, 60 },
   {  6, 47 },
   {  7, 43 },
   {  6, 49 },
   {  9, 43 },
   {  6, 51 },
   { 11, 43 },
   {  6, 54 },
   {  6, 57 },
   { 14, 72 },
   {  6, 60 },
   { 16, 76 },
   { 17, 84 },
   { 18, 36 },
   { 19, 76 },
   { 20, 84 },
   { 21, 83 },
   { 22, 84 },
   { 23, 24 },
   { 16, 77 },
   { 25, 60 },
   { 26, 65 },
   { 27, 59 },
   { 28, 51 },
   { 29, 45 },
   { 30, 71 },
   { 31, 60 },
   { 32, 58 },
   { 33, 53 },
   { 34, 64 },
   { 35, 71 },
   { 36, 61 },
   { 37, 61 },
   { 38, 48 },
   { 39, 48 },
   { 40, 69 },
   { 41, 68 },
   { 42, 63 },
   { 43, 74 },
   { 44, 60 },
   { 45, 80 },
   { 46, 64 },
   { 47, 69 },
   { 48, 73 },
   { 49, 75 },
   { 50, 68 },
   { 51, 48 },
   { 52, 53 }
};

/*****************************************************************************
 * Operator offset table
 * Maps voice number (0-17) to operator register offsets for each of 2 ops.
 */
static WORD gw2OpOffset[NUM2VOICES][2] =
{
   { 0x000,0x003 },
   { 0x001,0x004 },
   { 0x002,0x005 },
   { 0x008,0x00b },
   { 0x009,0x00c },
   { 0x00a,0x00d },
   { 0x010,0x013 },
   { 0x011,0x014 },
   { 0x012,0x015 },
   { 0x100,0x103 },
   { 0x101,0x104 },
   { 0x102,0x105 },
   { 0x108,0x10b },
   { 0x109,0x10c },
   { 0x10a,0x10d },
   { 0x110,0x113 },
   { 0x111,0x114 },
   { 0x112,0x115 },
};

/*****************************************************************************
 * Pitch table
 * OPL3 frequency numbers for notes C through B at middle octave.
 */
static DWORD gdwPitch[12] = {
        PITCH(C), PITCH(CSHARP), PITCH(D), PITCH(DSHARP),
        PITCH(E), PITCH(F), PITCH(FSHARP), PITCH(G),
        PITCH(GSHARP), PITCH(A), PITCH(ASHARP), PITCH(B)};

/*****************************************************************************
 * Slot offset table
 * For silencing all operator slots.
 */
static BYTE offsetSlot[] =
{
    0, 1, 2, 3, 4, 5,
    8, 9, 10, 11, 12, 13,
    16, 17, 18, 19, 20, 21
};


/*****************************************************************************
 * Patch data table
 * 256 entries of OPL3 instrument patch data (128 melodic + 128 percussion).
 */
static patchStruct glpPatch[] = 
{
    {   //  1st patch struct
        0x01,0x8f,0xf2,0xf4,0x00,0x01,0x06,0xf2,0xf7,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x00,0x02,0x00
    },{ //  2nd patch struct
        0x01,0x4b,0xf2,0xf4,0x00,0x01,0x00,0xf2,0xf7,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x00,0x02,0x00
    },{ //  3rd patch struct
        0x01,0x49,0xf2,0xf4,0x00,0x01,0x00,0xf2,0xf6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x00,0x02,0x00
    },{ //  4th patch struct
        0x81,0x12,0xf2,0xf7,0x00,0x41,0x00,0xf2,0xf7,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x36,0x00,0x02,0x00
    },{ //  5th patch struct
        0x01,0x57,0xf1,0xf7,0x00,0x01,0x00,0xf2,0xf7,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  6th patch struct
        0x01,0x93,0xf1,0xf7,0x00,0x01,0x00,0xf2,0xf7,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  7th patch struct
        0x01,0x80,0xa1,0xf2,0x00,0x16,0x0e,0xf2,0xf5,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x00,0x02,0x00
    },{ //  8th patch struct
        0x01,0x92,0xc2,0xf8,0x00,0x01,0x00,0xc2,0xf8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3a,0x00,0x02,0x00
    },{ //  9th patch struct
        0x0c,0x5c,0xf6,0xf4,0x00,0x81,0x00,0xf3,0xf5,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  10th patch struct
        0x07,0x97,0xf3,0xf2,0x00,0x11,0x80,0xf2,0xf1,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x32,0x00,0x02,0x00
    },{ //  11th patch struct
        0x17,0x21,0x54,0xf4,0x00,0x01,0x00,0xf4,0xf4,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x32,0x00,0x02,0x00
    },{ //  12th patch struct
        0x98,0x62,0xf3,0xf6,0x00,0x81,0x00,0xf2,0xf6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  13th patch struct
        0x18,0x23,0xf6,0xf6,0x00,0x01,0x00,0xe7,0xf7,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  14th patch struct
        0x15,0x91,0xf6,0xf6,0x00,0x01,0x00,0xf6,0xf6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x34,0x00,0x02,0x00
    },{ //  15th patch struct
        0x45,0x59,0xd3,0xf3,0x00,0x81,0x80,0xa3,0xf3,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3c,0x00,0x02,0x00
    },{ //  16th patch struct
        0x03,0x49,0x75,0xf5,0x01,0x81,0x80,0xb5,0xf5,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x34,0x00,0x02,0x00
    },{ //  17th patch struct
        0x71,0x92,0xf6,0x14,0x00,0x31,0x00,0xf1,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x32,0x00,0x02,0x00
    },{ //  18th patch struct
        0x72,0x14,0xc7,0x58,0x00,0x30,0x00,0xc7,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x32,0x00,0x02,0x00
    },{ //  19th patch struct
        0x70,0x44,0xaa,0x18,0x00,0xb1,0x00,0x8a,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x34,0x00,0x02,0x00
    },{ //  20th patch struct
        0x23,0x93,0x97,0x23,0x01,0xb1,0x00,0x55,0x14,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x34,0x00,0x02,0x00
    },{ //  21th patch struct
        0x61,0x13,0x97,0x04,0x01,0xb1,0x80,0x55,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  22th patch struct
        0x24,0x48,0x98,0x2a,0x01,0xb1,0x00,0x46,0x1a,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3c,0x00,0x02,0x00
    },{ //  23th patch struct
        0x61,0x13,0x91,0x06,0x01,0x21,0x00,0x61,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3a,0x00,0x02,0x00
    },{ //  24th patch struct
        0x21,0x13,0x71,0x06,0x00,0xa1,0x89,0x61,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x36,0x00,0x02,0x00
    },{ //  25th patch struct
        0x02,0x9c,0xf3,0x94,0x01,0x41,0x80,0xf3,0xc8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3c,0x00,0x02,0x00
    },{ //  26th patch struct
        0x03,0x54,0xf3,0x9a,0x01,0x11,0x00,0xf1,0xe7,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3c,0x00,0x02,0x00
    },{ //  27th patch struct
        0x23,0x5f,0xf1,0x3a,0x00,0x21,0x00,0xf2,0xf8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  28th patch struct
        0x03,0x87,0xf6,0x22,0x01,0x21,0x80,0xf3,0xf8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x36,0x00,0x02,0x00
    },{ //  29th patch struct
        0x03,0x47,0xf9,0x54,0x00,0x21,0x00,0xf6,0x3a,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  30th patch struct
        0x23,0x4a,0x91,0x41,0x01,0x21,0x05,0x84,0x19,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x00,0x02,0x00
    },{ //  31th patch struct
        0x23,0x4a,0x95,0x19,0x01,0x21,0x00,0x94,0x19,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x00,0x02,0x00
    },{ //  32th patch struct
        0x09,0xa1,0x20,0x4f,0x00,0x84,0x80,0xd1,0xf8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x00,0x02,0x00
    },{ //  33th patch struct
        0x21,0x1e,0x94,0x06,0x00,0xa2,0x00,0xc3,0xa6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x32,0x00,0x02,0x00
    },{ //  34th patch struct
        0x31,0x12,0xf1,0x28,0x00,0x31,0x00,0xf1,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3a,0x00,0x02,0x00
    },{ //  35th patch struct
        0x31,0x8d,0xf1,0xe8,0x00,0x31,0x00,0xf1,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3a,0x00,0x02,0x00
    },{ //  36th patch struct
        0x31,0x5b,0x51,0x28,0x00,0x32,0x00,0x71,0x48,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3c,0x00,0x02,0x00
    },{ //  37th patch struct
        0x01,0x8b,0xa1,0x9a,0x00,0x21,0x40,0xf2,0xdf,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x00,0x02,0x00
    },{ //  38th patch struct
        0x21,0x8b,0xa2,0x16,0x00,0x21,0x08,0xa1,0xdf,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x00,0x02,0x00
    },{ //  39th patch struct
        0x31,0x8b,0xf4,0xe8,0x00,0x31,0x00,0xf1,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3a,0x00,0x02,0x00
    },{ //  40th patch struct
        0x31,0x12,0xf1,0x28,0x00,0x31,0x00,0xf1,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3a,0x00,0x02,0x00
    },{ //  41th patch struct
        0x31,0x15,0xdd,0x13,0x01,0x21,0x00,0x56,0x26,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x00,0x02,0x00
    },{ //  42th patch struct
        0x31,0x16,0xdd,0x13,0x01,0x21,0x00,0x66,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x00,0x02,0x00
    },{ //  43th patch struct
        0x71,0x49,0xd1,0x1c,0x01,0x31,0x00,0x61,0x0c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x00,0x02,0x00
    },{ //  44th patch struct
        0x21,0x4d,0x71,0x12,0x01,0x23,0x80,0x72,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x32,0x00,0x02,0x00
    },{ //  45th patch struct
        0xf1,0x40,0xf1,0x21,0x01,0xe1,0x00,0x6f,0x16,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x32,0x00,0x02,0x00
    },{ //  46th patch struct
        0x02,0x1a,0xf5,0x75,0x01,0x01,0x80,0x85,0x35,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  47th patch struct
        0x02,0x1d,0xf5,0x75,0x01,0x01,0x80,0xf3,0xf4,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  48th patch struct
        0x10,0x41,0xf5,0x05,0x01,0x11,0x00,0xf2,0xc3,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x32,0x00,0x02,0x00
    },{ //  49th patch struct
        0x21,0x9b,0xb1,0x25,0x01,0xa2,0x01,0x72,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  50th patch struct
        0xa1,0x98,0x7f,0x03,0x01,0x21,0x00,0x3f,0x07,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  51st patch struct
        0xa1,0x93,0xc1,0x12,0x00,0x61,0x00,0x4f,0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3a,0x00,0x02,0x00
    },{ //  52th patch struct
        0x21,0x18,0xc1,0x22,0x00,0x61,0x00,0x4f,0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3c,0x00,0x02,0x00
    },{ //  53th patch struct
        0x31,0x5b,0xf4,0x15,0x00,0x72,0x83,0x8a,0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  54th patch struct
        0xa1,0x90,0x74,0x39,0x00,0x61,0x00,0x71,0x67,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  55th patch struct
        0x71,0x57,0x54,0x05,0x00,0x72,0x00,0x7a,0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3c,0x00,0x02,0x00
    },{ //  56th patch struct
        0x90,0x00,0x54,0x63,0x00,0x41,0x00,0xa5,0x45,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x00,0x02,0x00
    },{ //  57th patch struct
        0x21,0x92,0x85,0x17,0x00,0x21,0x01,0x8f,0x09,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3c,0x00,0x02,0x00
    },{ //  58th patch struct
        0x21,0x94,0x75,0x17,0x00,0x21,0x05,0x8f,0x09,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3c,0x00,0x02,0x00
    },{ //  59th patch struct
        0x21,0x94,0x76,0x15,0x00,0x61,0x00,0x82,0x37,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3c,0x00,0x02,0x00
    },{ //  60th patch struct
        0x31,0x43,0x9e,0x17,0x01,0x21,0x00,0x62,0x2c,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x32,0x00,0x02,0x00
    },{ //  61th patch struct
        0x21,0x9b,0x61,0x6a,0x00,0x21,0x00,0x7f,0x0a,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x32,0x00,0x02,0x00
    },{ //  62th patch struct
        0x61,0x8a,0x75,0x1f,0x00,0x22,0x06,0x74,0x0f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x00,0x02,0x00
    },{ //  63th patch struct
        0xa1,0x86,0x72,0x55,0x01,0x21,0x83,0x71,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  64th patch struct
        0x21,0x4d,0x54,0x3c,0x00,0x21,0x00,0xa6,0x1c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x00,0x02,0x00
    },{ //  65th patch struct
        0x31,0x8f,0x93,0x02,0x01,0x61,0x00,0x72,0x0b,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x00,0x02,0x00
    },{ //  66th patch struct
        0x31,0x8e,0x93,0x03,0x01,0x61,0x00,0x72,0x09,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x00,0x02,0x00
    },{ //  th patch struct
        0x31,0x91,0x93,0x03,0x01,0x61,0x00,0x82,0x09,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3a,0x00,0x02,0x00
    },{ //  th patch struct
        0x31,0x8e,0x93,0x0f,0x01,0x61,0x00,0x72,0x0f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3a,0x00,0x02,0x00
    },{ //  th patch struct
        0x21,0x4b,0xaa,0x16,0x01,0x21,0x00,0x8f,0x0a,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x00,0x02,0x00
    },{ //  70th patch struct
        0x31,0x90,0x7e,0x17,0x01,0x21,0x00,0x8b,0x0c,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x36,0x00,0x02,0x00
    },{ //  71th patch struct
        0x31,0x81,0x75,0x19,0x01,0x32,0x00,0x61,0x19,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  72th patch struct
        0x32,0x90,0x9b,0x21,0x00,0x21,0x00,0x72,0x17,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x34,0x00,0x02,0x00
    },{ //  73th patch struct
        0xe1,0x1f,0x85,0x5f,0x00,0xe1,0x00,0x65,0x1a,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  74th patch struct
        0xe1,0x46,0x88,0x5f,0x00,0xe1,0x00,0x65,0x1a,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  75th patch struct
        0xa1,0x9c,0x75,0x1f,0x00,0x21,0x00,0x75,0x0a,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x32,0x00,0x02,0x00
    },{ //  76th patch struct
        0x31,0x8b,0x84,0x58,0x00,0x21,0x00,0x65,0x1a,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  77th patch struct
        0xe1,0x4c,0x66,0x56,0x00,0xa1,0x00,0x65,0x26,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  78th patch struct
        0x62,0xcb,0x76,0x46,0x00,0xa1,0x00,0x55,0x36,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  79th patch struct
        0x62,0x99,0x57,0x07,0x00,0xa1,0x00,0x56,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3b,0x00,0x02,0x00
    },{ //  80th patch struct
        0x62,0x93,0x77,0x07,0x00,0xa1,0x00,0x76,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3b,0x00,0x02,0x00
    },{ //  th patch struct
        0x22,0x59,0xff,0x03,0x02,0x21,0x00,0xff,0x0f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  th patch struct
        0x21,0x0e,0xff,0x0f,0x01,0x21,0x00,0xff,0x0f,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  th patch struct
        0x22,0x46,0x86,0x55,0x00,0x21,0x80,0x64,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  th patch struct
        0x21,0x45,0x66,0x12,0x00,0xa1,0x00,0x96,0x0a,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  85th patch struct
        0x21,0x8b,0x92,0x2a,0x01,0x22,0x00,0x91,0x2a,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  th patch struct
        0xa2,0x9e,0xdf,0x05,0x00,0x61,0x40,0x6f,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x32,0x00,0x02,0x00
    },{ //  th patch struct
        0x20,0x1a,0xef,0x01,0x00,0x60,0x00,0x8f,0x06,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  th patch struct
        0x21,0x8f,0xf1,0x29,0x00,0x21,0x80,0xf4,0x09,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3a,0x00,0x02,0x00
    },{ //  th patch struct
        0x77,0xa5,0x53,0x94,0x00,0xa1,0x00,0xa0,0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x32,0x00,0x02,0x00
    },{ //  90th patch struct
        0x61,0x1f,0xa8,0x11,0x00,0xb1,0x80,0x25,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3a,0x00,0x02,0x00
    },{ //  th patch struct
        0x61,0x17,0x91,0x34,0x00,0x61,0x00,0x55,0x16,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3c,0x00,0x02,0x00
    },{ //  th patch struct
        0x71,0x5d,0x54,0x01,0x00,0x72,0x00,0x6a,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  th patch struct
        0x21,0x97,0x21,0x43,0x00,0xa2,0x00,0x42,0x35,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x00,0x02,0x00
    },{ //  th patch struct
        0xa1,0x1c,0xa1,0x77,0x01,0x21,0x00,0x31,0x47,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  95th patch struct
        0x21,0x89,0x11,0x33,0x00,0x61,0x03,0x42,0x25,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3a,0x00,0x02,0x00
    },{ //  th patch struct
        0xa1,0x15,0x11,0x47,0x01,0x21,0x00,0xcf,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  th patch struct
        0x3a,0xce,0xf8,0xf6,0x00,0x51,0x00,0x86,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x32,0x00,0x02,0x00
    },{ //  th patch struct
        0x21,0x15,0x21,0x23,0x01,0x21,0x00,0x41,0x13,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  th patch struct
        0x06,0x5b,0x74,0x95,0x00,0x01,0x00,0xa5,0x72,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  100th patch struct
        0x22,0x92,0xb1,0x81,0x00,0x61,0x83,0xf2,0x26,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3c,0x00,0x02,0x00
    },{ //  th patch struct
        0x41,0x4d,0xf1,0x51,0x01,0x42,0x00,0xf2,0xf5,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  th patch struct
        0x61,0x94,0x11,0x51,0x01,0xa3,0x80,0x11,0x13,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x36,0x00,0x02,0x00
    },{ //  th patch struct
        0x61,0x8c,0x11,0x31,0x00,0xa1,0x80,0x1d,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x36,0x00,0x02,0x00
    },{ //  th patch struct
        0xa4,0x4c,0xf3,0x73,0x01,0x61,0x00,0x81,0x23,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x34,0x00,0x02,0x00
    },{ //  105th patch struct
        0x02,0x85,0xd2,0x53,0x00,0x07,0x03,0xf2,0xf6,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  th patch struct
        0x11,0x0c,0xa3,0x11,0x01,0x13,0x80,0xa2,0xe5,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  th patch struct
        0x11,0x06,0xf6,0x41,0x01,0x11,0x00,0xf2,0xe6,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x34,0x00,0x02,0x00
    },{ //  th patch struct
        0x93,0x91,0xd4,0x32,0x00,0x91,0x00,0xeb,0x11,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x00,0x02,0x00
    },{ //  th patch struct
        0x04,0x4f,0xfa,0x56,0x00,0x01,0x00,0xc2,0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3c,0x00,0x02,0x00
    },{ //  110th patch struct
        0x21,0x49,0x7c,0x20,0x00,0x22,0x00,0x6f,0x0c,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x36,0x00,0x02,0x00
    },{ //  th patch struct
        0x31,0x85,0xdd,0x33,0x01,0x21,0x00,0x56,0x16,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3a,0x00,0x02,0x00
    },{ //  th patch struct
        0x20,0x04,0xda,0x05,0x02,0x21,0x81,0x8f,0x0b,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x36,0x00,0x02,0x00
    },{ //  th patch struct
        0x05,0x6a,0xf1,0xe5,0x00,0x03,0x80,0xc3,0xe5,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x36,0x00,0x02,0x00
    },{ //  th patch struct
        0x07,0x15,0xec,0x26,0x00,0x02,0x00,0xf8,0x16,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3a,0x00,0x02,0x00
    },{ //  115th patch struct
        0x05,0x9d,0x67,0x35,0x00,0x01,0x00,0xdf,0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x00,0x02,0x00
    },{ //  th patch struct
        0x18,0x96,0xfa,0x28,0x00,0x12,0x00,0xf8,0xe5,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3a,0x00,0x02,0x00
    },{ //  th patch struct
        0x10,0x86,0xa8,0x07,0x00,0x00,0x03,0xfa,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x36,0x00,0x02,0x00
    },{ //  th patch struct
        0x11,0x41,0xf8,0x47,0x02,0x10,0x03,0xf3,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x34,0x00,0x02,0x00
    },{ //  th patch struct
        0x01,0x8e,0xf1,0x06,0x02,0x10,0x00,0xf3,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  120th patch struct
        0x0e,0x00,0x1f,0x00,0x00,0xc0,0x00,0x1f,0xff,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  th patch struct
        0x06,0x80,0xf8,0x24,0x00,0x03,0x88,0x56,0x84,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  th patch struct
        0x0e,0x00,0xf8,0x00,0x00,0xd0,0x05,0x34,0x04,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  th patch struct
        0x0e,0x00,0xf6,0x00,0x00,0xc0,0x00,0x1f,0x02,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  th patch struct
        0xd5,0x95,0x37,0xa3,0x00,0xda,0x40,0x56,0x37,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  125th patch struct
        0x35,0x5c,0xb2,0x61,0x02,0x14,0x08,0xf4,0x15,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3a,0x00,0x02,0x00
    },{ //  126th patch struct
        0x0e,0x00,0xf6,0x00,0x00,0xd0,0x00,0x4f,0xf5,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  127th patch struct
        0x26,0x00,0xff,0x01,0x00,0xe4,0x00,0x12,0x16,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  128th patch struct
        0x00,0x00,0xf3,0xf0,0x00,0x00,0x00,0xf6,0xc9,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  129th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  130th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  133th patch struct 
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  135th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  138th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  140th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  143th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  145th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  148th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  150th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  153th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  155th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  158th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  160th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  164th patch struct    FIRST DRUM patch. note 35
        0x10,0x44,0xf8,0x77,0x02,0x11,0x00,0xf3,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x00,0x02,0x00
    },{ //  165th patch struct
        0x10,0x44,0xf8,0x77,0x02,0x11,0x00,0xf3,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x00,0x02,0x00
    },{ //  th patch struct
        0x02,0x07,0xf9,0xff,0x00,0x11,0x00,0xf8,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x00,0x02,0x00
    },{ //  th patch struct
        0x00,0x00,0xfc,0x05,0x02,0x00,0x00,0xfa,0x17,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  th patch struct
        0x00,0x02,0xff,0x07,0x00,0x01,0x00,0xff,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  th patch struct
        0x00,0x00,0xfc,0x05,0x02,0x00,0x00,0xfa,0x17,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  170th patch struct
        0x00,0x00,0xf6,0x0c,0x00,0x00,0x00,0xf6,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x34,0x00,0x02,0x00
    },{ //  th patch struct
        0x0c,0x00,0xf6,0x08,0x00,0x12,0x00,0xfb,0x47,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3a,0x00,0x02,0x00
    },{ //  th patch struct
        0x00,0x03,0xf8,0x2a,0x00,0x00,0x00,0xf6,0x45,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x34,0x00,0x02,0x00
    },{ //  th patch struct
        0x0c,0x00,0xf6,0x08,0x00,0x12,0x05,0x7b,0x47,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3a,0x00,0x02,0x00
    },{ //  th patch struct
        0x00,0x03,0xf8,0x2a,0x00,0x00,0x00,0xf6,0x45,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x34,0x00,0x02,0x00
    },{ //  175th patch struct
        0x0c,0x00,0xf6,0x02,0x00,0x12,0x00,0xcb,0x43,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3a,0x00,0x02,0x00
    },{ //  th patch struct
        0x00,0x03,0xf8,0x2a,0x00,0x00,0x00,0xf6,0x45,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x34,0x00,0x02,0x00
    },{ //  th patch struct
        0x00,0x03,0xf8,0x2a,0x00,0x00,0x00,0xf6,0x45,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x34,0x00,0x02,0x00
    },{ //  th patch struct
        0x0e,0x00,0xf6,0x00,0x00,0xd0,0x00,0x9f,0x02,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  th patch struct
        0x00,0x03,0xf8,0x2a,0x00,0x00,0x00,0xf6,0x45,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x34,0x00,0x02,0x00
    },{ //  180th patch struct
        0x0e,0x08,0xf8,0x42,0x00,0x07,0x4a,0xf4,0xe4,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  th patch struct
        0x0e,0x00,0xf5,0x30,0x00,0xd0,0x0a,0x9f,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  th patch struct
        0x0e,0x0a,0xe4,0xe4,0x03,0x07,0x5d,0xf5,0xe5,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x36,0x00,0x02,0x00
    },{ //  th patch struct
        0x02,0x03,0xb4,0x04,0x00,0x05,0x0a,0x97,0xf7,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  th patch struct
        0x4e,0x00,0xf6,0x00,0x00,0x9e,0x00,0x9f,0x02,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  185th patch struct
        0x11,0x45,0xf8,0x37,0x02,0x10,0x08,0xf3,0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x38,0x00,0x02,0x00
    },{ //  th patch struct
        0x0e,0x00,0xf6,0x00,0x00,0xd0,0x00,0x9f,0x02,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  th patch struct
        0x80,0x00,0xff,0x03,0x03,0x10,0x0d,0xff,0x14,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3c,0x00,0x02,0x00
    },{ //  th patch struct note 59
        0x0e,0x08,0xf8,0x42,0x00,0x07,0x51,0xf4,0xe4,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  th patch struct note 60
        0x06,0x0b,0xf5,0x0c,0x00,0x02,0x00,0xf5,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x36,0x00,0x02,0x00
    },{ //  190th patch struct note 61
        0x01,0x00,0xfa,0xbf,0x00,0x02,0x00,0xc8,0x97,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x37,0x00,0x02,0x00
    },{ //  th patch struct note 62
        0x01,0x51,0xfa,0x87,0x00,0x01,0x00,0xfa,0xb7,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x36,0x00,0x02,0x00
    },{ //  th patch struct note 63
        0x01,0x54,0xfa,0x8d,0x00,0x02,0x00,0xf8,0xb8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x36,0x00,0x02,0x00
    },{ //  th patch struct note 64
        0x01,0x59,0xfa,0x88,0x00,0x02,0x00,0xf8,0xb6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x36,0x00,0x02,0x00
    },{ //  th patch struct note 65
        0x01,0x00,0xf9,0x0a,0x03,0x00,0x00,0xfa,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  195th patch struct note 66
        0x00,0x80,0xf9,0x89,0x03,0x00,0x00,0xf6,0x6c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  th patch struct note 67
        0x03,0x80,0xf8,0x88,0x03,0x0c,0x08,0xf6,0xb6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3f,0x00,0x02,0x00
    },{ //  th patch struct note 68
        0x03,0x85,0xf8,0x88,0x03,0x0c,0x00,0xf6,0xb6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3f,0x00,0x02,0x00
    },{ //  th patch struct note 69
        0x0e,0x40,0x76,0x4f,0x00,0x00,0x08,0x77,0x18,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  th patch struct note 70
        0x0e,0x40,0xc8,0x49,0x00,0x03,0x00,0x9b,0x69,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  200th patch struct note 71
        0xd7,0xdc,0xad,0x05,0x03,0xc7,0x00,0x8d,0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  201th patch struct note 72
        0xd7,0xdc,0xa8,0x04,0x03,0xc7,0x00,0x88,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  202th patch struct note 73
        0x80,0x00,0xf6,0x06,0x03,0x11,0x00,0x67,0x17,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  203th patch struct note 74
        0x80,0x00,0xf5,0x05,0x02,0x11,0x09,0x46,0x16,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x3e,0x00,0x02,0x00
    },{ //  204th patch struct note 75
        0x06,0x3f,0x00,0xf4,0x00,0x15,0x00,0xf7,0xf5,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x31,0x00,0x02,0x00
    },{ //  205th patch struct     42nd DRUM patch note 76
        0x06,0x3f,0x00,0xf4,0x03,0x12,0x00,0xf7,0xf5,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x30,0x00,0x02,0x00
    },{ //  206th patch struct note 77 (low wood block from 60 high bongo)
        0x06,0x0b,0xf5,0x0c,0x00,0x02,0x00,0xf5,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0C,0x00,0x36,0x00,0x02,0x00
//        0x06,0x0b,0xf5,0x0c,0x00,0x02,0x00,0xf5,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x36,0x00,0x02,0x00
    },{ //  207th patch struct note 78 (mute cuica from 62 mute hi conga)
        0x01,0x51,0xfa,0x87,0x00,0x01,0x00,0xfa,0xb7,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0C,0x00,0x36,0x00,0x02,0x00
//        0x01,0x51,0xfa,0x87,0x00,0x01,0x00,0xfa,0xb7,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x36,0x00,0x02,0x00
    },{ //  208th patch struct note 79 (open cuica from 63 open hi conga)
        0x01,0x54,0xfa,0x8d,0x00,0x02,0x00,0xf8,0xb8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0C,0x00,0x36,0x00,0x02,0x00
//        0x01,0x54,0xfa,0x8d,0x00,0x02,0x00,0xf8,0xb8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x36,0x00,0x02,0x00
    },{ //  209th patch struct note 80 (mute triangle from NT - note 53 ride bell)
        0x01,0x2E,0xF5,0xF5,0x05,0x11,0x02,0xA5,0x34,0x00,0x0E,0x08,0xF1,0xF1,0x02,0x18,0x05,0xC9,0xA6,0x02,0x9A,0x67,0x14,0x10,0x30,0x7E,0x01,0x9A 
//        0x01,0x2E,0xF5,0xF5,0x05,0x11,0x02,0xA5,0x34,0x00,0x0E,0x08,0xF1,0xF1,0x02,0x18,0x05,0xC9,0xA6,0x02,0x9A,0x67,0x10,0x10,0x30,0x7E,0x01,0x9A 
    },{ //  210th patch struct note 81 (open triangle from NT - note 81)
        0x29,0x27,0xF1,0x41,0x00,0x04,0x00,0xF7,0x43,0x00,0x9A,0xFE,0x05,0x00,0x00,0x52,0x50,0x9A,0x1E,0x06,0x00,0x00,0x1C,0x10,0x32,0x5A,0x02,0x6A
//        0x29,0x27,0xF1,0x41,0x00,0x04,0x00,0xF7,0x43,0x00,0x9A,0xFE,0x05,0x00,0x00,0x52,0x50,0x9A,0x1E,0x06,0x00,0x00,0x18,0x10,0x32,0x5A,0x02,0x6A
    },{ //  211th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  212th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  213th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  214th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  215th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  216th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  221th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  226th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  231th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  236th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  240th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  245th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  246th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  247th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  248th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  249th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  250th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  251th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  252th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  253th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  254th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  255th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },{ //  256th patch struct
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    }
};


/*****************************************************************************
 * Filter descriptor tables
 */

static
KSDATARANGE_MUSIC PinDataRangesStream[] =
{
    {
        {
            sizeof(KSDATARANGE_MUSIC),
            0,
            0,
            0,
            STATICGUIDOF(KSDATAFORMAT_TYPE_MUSIC),
            STATICGUIDOF(KSDATAFORMAT_SUBTYPE_MIDI),
            STATICGUIDOF(KSDATAFORMAT_SPECIFIER_NONE)
        },
        STATICGUIDOF(KSMUSIC_TECHNOLOGY_FMSYNTH),
        NUM2VOICES,
        NUM2VOICES,
        0xffffffff
    }
};

static
PKSDATARANGE PinDataRangePointersStream[] =
{
    PKSDATARANGE(&PinDataRangesStream[0])
};

static
KSDATARANGE PinDataRangesBridge[] =
{
   {
      sizeof(KSDATARANGE),
      0,
      0,
      0,
      STATICGUIDOF(KSDATAFORMAT_TYPE_MUSIC),
      STATICGUIDOF(KSDATAFORMAT_SUBTYPE_MIDI_BUS),
      STATICGUIDOF(KSDATAFORMAT_SPECIFIER_NONE)
   }
};

static
PKSDATARANGE PinDataRangePointersBridge[] =
{
    &PinDataRangesBridge[0]
};

static
PCPIN_DESCRIPTOR MiniportPins[] =
{
    {
        1,1,1,  // InstanceCount
        NULL,   // AutomationTable
        {       // KsPinDescriptor
            0,                                          // InterfacesCount
            NULL,                                       // Interfaces
            0,                                          // MediumsCount
            NULL,                                       // Mediums
            SIZEOF_ARRAY(PinDataRangePointersStream),   // DataRangesCount
            PinDataRangePointersStream,                 // DataRanges
            KSPIN_DATAFLOW_IN,                          // DataFlow
            KSPIN_COMMUNICATION_SINK,                   // Communication
            (GUID *) &KSNODETYPE_SYNTHESIZER,           // Category
            NULL,                                       // Name
            0                                           // Reserved
        }
    },
    {
        0,0,0,  // InstanceCount
        NULL,   // AutomationTable
        {       // KsPinDescriptor
            0,                                          // InterfacesCount
            NULL,                                       // Interfaces
            0,                                          // MediumsCount
            NULL,                                       // Mediums
            SIZEOF_ARRAY(PinDataRangePointersBridge),   // DataRangesCount
            PinDataRangePointersBridge,                 // DataRanges
            KSPIN_DATAFLOW_OUT,                         // DataFlow
            KSPIN_COMMUNICATION_NONE,                   // Communication
            (GUID *) &KSCATEGORY_AUDIO,                 // Category
            NULL,                                       // Name
            0                                           // Reserved
        }
    }
};

enum {
    eFMSynthNode  = 0
};

enum {
    eFMNodeOutput = 0,
    eFMNodeInput  = 1
};

enum {
    eFilterInput  = eFMNodeOutput,
    eBridgeOutput = eFMNodeInput
};

static
PCNODE_DESCRIPTOR MiniportNodes[] =
{
    {
        0,                          // Flags
        NULL,                       // AutomationTable
        &KSNODETYPE_SYNTHESIZER,    // Type
        NULL                        // Name
    }
};

static
PCCONNECTION_DESCRIPTOR MiniportConnections[] =
{
    //  FromNode,       FromPin,        ToNode,         ToPin
    {   PCFILTER_NODE,  eFilterInput,   eFMSynthNode,   eFMNodeInput },
    {   eFMSynthNode,   eFMNodeOutput,  PCFILTER_NODE,  eBridgeOutput }
};

static
PCFILTER_DESCRIPTOR MiniportFilterDescriptor =
{
    0,                                  // Version
    NULL,                               // AutomationTable
    sizeof(PCPIN_DESCRIPTOR),           // PinSize
    SIZEOF_ARRAY(MiniportPins),         // PinCount
    MiniportPins,                       // Pins
    sizeof(PCNODE_DESCRIPTOR),          // NodeSize
    SIZEOF_ARRAY(MiniportNodes),        // NodeCount
    MiniportNodes,                      // Nodes
    SIZEOF_ARRAY(MiniportConnections),  // ConnectionCount
    MiniportConnections,                // Connections
    0,                                  // CategoryCount
    NULL                                // Categories
};


/*****************************************************************************
 * CreateMiniportMidiFMAdLibGold()
 *****************************************************************************
 * Creates an FM synth miniport.
 */
#pragma code_seg("PAGE")
NTSTATUS
CreateMiniportMidiFMAdLibGold
(
    OUT     PUNKNOWN *  Unknown,
    IN      REFCLSID,
    IN      PUNKNOWN    UnknownOuter    OPTIONAL,
    IN      POOL_TYPE   PoolType
)
{
    PAGED_CODE();
    ASSERT(Unknown);

    STD_CREATE_BODY(CMiniportMidiFMAdLibGold, Unknown, UnknownOuter, PoolType);
}


/*****************************************************************************
 * CMiniportMidiFMAdLibGold::NonDelegatingQueryInterface()
 */
#pragma code_seg("PAGE")
STDMETHODIMP
CMiniportMidiFMAdLibGold::
NonDelegatingQueryInterface
(
    REFIID  Interface,
    PVOID * Object
)
{
    PAGED_CODE();
    ASSERT(Object);

    if (IsEqualGUIDAligned(Interface, IID_IUnknown))
    {
        *Object = PVOID(PUNKNOWN(PMINIPORT(this)));
    }
    else if (IsEqualGUIDAligned(Interface, IID_IMiniport))
    {
        *Object = PVOID(PMINIPORT(this));
    }
    else if (IsEqualGUIDAligned(Interface, IID_IMiniportMidi))
    {
        *Object = PVOID(PMINIPORTMIDI(this));
    }
    else if (IsEqualGUIDAligned(Interface, IID_IPowerNotify))
    {
        *Object = PVOID(PPOWERNOTIFY(this));
    }
    else
    {
        *Object = NULL;
    }

    if (*Object)
    {
        PUNKNOWN((PMINIPORT)*Object)->AddRef();
        return STATUS_SUCCESS;
    }

    return STATUS_INVALID_PARAMETER;
}


/*****************************************************************************
 * CMiniportMidiFMAdLibGold::~CMiniportMidiFMAdLibGold()
 */
#pragma code_seg()
CMiniportMidiFMAdLibGold::
~CMiniportMidiFMAdLibGold
(   void
)
{
    KIRQL oldIrql;

    _DbgPrintF(DEBUGLVL_VERBOSE, ("CMiniportMidiFMAdLibGold::~CMiniportMidiFMAdLibGold"));

    KeAcquireSpinLock(&m_SpinLock, &oldIrql);

    Opl3_BoardReset();

    /* Clear NEW bit to restore OPL2 compatibility before unload */
    SoundMidiSendFM(AD_NEW, 0x00);

    KeReleaseSpinLock(&m_SpinLock, oldIrql);

    if (m_Port)
    {
        m_Port->Release();
    }
    if (m_AdapterCommon)
    {
        m_AdapterCommon->Release();
    }
}


/*****************************************************************************
 * CMiniportMidiFMAdLibGold::Init()
 *****************************************************************************
 * Initializes the miniport.  Obtains adapter common for hardware access
 * and resets the OPL3 chip.  No board detection is done here -- the
 * adapter common already verified the card during its own Init().
 */
#pragma code_seg("PAGE")
STDMETHODIMP
CMiniportMidiFMAdLibGold::
Init
(
    IN      PUNKNOWN        UnknownAdapter  OPTIONAL,
    IN      PRESOURCELIST   ResourceList,
    IN      PPORTMIDI       Port_,
    OUT     PSERVICEGROUP * ServiceGroup
)
{
    PAGED_CODE();

    ASSERT(ResourceList);
    ASSERT(Port_);
    ASSERT(ServiceGroup);

    int i;

    _DbgPrintF(DEBUGLVL_VERBOSE, ("CMiniportMidiFMAdLibGold::Init"));

    m_Port = Port_;
    m_Port->AddRef();

    KeInitializeSpinLock(&m_SpinLock);

    /*
     * Obtain IAdapterCommon from the adapter.
     */
    NTSTATUS ntStatus;
    if (UnknownAdapter)
    {
        ntStatus = UnknownAdapter->QueryInterface(IID_IAdapterCommon,
                                                   (PVOID *)&m_AdapterCommon);
    }
    else
    {
        ntStatus = STATUS_INVALID_PARAMETER;
    }

    if (NT_SUCCESS(ntStatus))
    {
        KIRQL oldIrql;
        KeAcquireSpinLock(&m_SpinLock, &oldIrql);

        for (i = 0; i < 0x200; i++)
            m_SavedRegValues[i] = 0x00;

        /* No board detection -- adapter common already verified the card. */
        Opl3_BoardReset();

        KeReleaseSpinLock(&m_SpinLock, oldIrql);

        *ServiceGroup = NULL;
    }

    if (!NT_SUCCESS(ntStatus))
    {
        m_Port->Release();
        m_Port = NULL;
        if (m_AdapterCommon)
        {
            m_AdapterCommon->Release();
            m_AdapterCommon = NULL;
        }
    }

    return ntStatus;
}


/*****************************************************************************
 * CMiniportMidiFMAdLibGold::NewStream()
 */
#pragma code_seg("PAGE")
STDMETHODIMP
CMiniportMidiFMAdLibGold::
NewStream
(
    OUT     PMINIPORTMIDISTREAM *   Stream,
    IN      PUNKNOWN                OuterUnknown    OPTIONAL,
    IN      POOL_TYPE               PoolType,
    IN      ULONG                   Pin,
    IN      BOOLEAN                 Capture,
    IN      PKSDATAFORMAT           DataFormat,
    OUT     PSERVICEGROUP *         ServiceGroup
)
{
    PAGED_CODE();

    NTSTATUS ntStatus = STATUS_SUCCESS;

    if (m_fStreamExists)
    {
        _DbgPrintF(DEBUGLVL_TERSE, ("NewStream: stream already exists"));
        ntStatus = STATUS_INVALID_DEVICE_REQUEST;
    }
    else
    {
        CMiniportMidiStreamFMAdLibGold *pStream =
            new(PoolType) CMiniportMidiStreamFMAdLibGold(OuterUnknown);

        if (pStream)
        {
            pStream->AddRef();

            ntStatus = pStream->Init(this);

            if (NT_SUCCESS(ntStatus))
            {
                *Stream = PMINIPORTMIDISTREAM(pStream);
                (*Stream)->AddRef();

                *ServiceGroup = NULL;
                m_fStreamExists = TRUE;
            }

            pStream->Release();
        }
        else
        {
            ntStatus = STATUS_INSUFFICIENT_RESOURCES;
        }
    }

    return ntStatus;
}


/*****************************************************************************
 * CMiniportMidiFMAdLibGold::Service()
 *****************************************************************************
 * No DPC callback needed -- FM synth is write-only.
 */
#pragma code_seg()
STDMETHODIMP_(void)
CMiniportMidiFMAdLibGold::
Service
(   void
)
{
}


/*****************************************************************************
 * CMiniportMidiFMAdLibGold::GetDescription()
 */
#pragma code_seg("PAGE")
STDMETHODIMP
CMiniportMidiFMAdLibGold::
GetDescription
(
    OUT     PPCFILTER_DESCRIPTOR *  OutFilterDescriptor
)
{
    PAGED_CODE();
    ASSERT(OutFilterDescriptor);

    *OutFilterDescriptor = &MiniportFilterDescriptor;

    return STATUS_SUCCESS;
}


/*****************************************************************************
 * CMiniportMidiFMAdLibGold::PowerChangeNotify()
 */
#pragma code_seg("PAGE")
STDMETHODIMP_(void)
CMiniportMidiFMAdLibGold::
PowerChangeNotify
(
    IN  POWER_STATE PowerState
)
{
    PAGED_CODE();

    _DbgPrintF(DEBUGLVL_VERBOSE, ("PowerChangeNotify(%d)", PowerState));

    switch (PowerState.DeviceState)
    {
    case PowerDeviceD0:
        if (m_PowerState.DeviceState != PowerDeviceD0)
        {
            MiniportMidiFMResume();
        }
        break;

    case PowerDeviceD1:
    case PowerDeviceD2:
    case PowerDeviceD3:
    default:
        break;
    }
    m_PowerState.DeviceState = PowerState.DeviceState;
}


/*****************************************************************************
 * CMiniportMidiFMAdLibGold::SoundMidiSendFM()
 *****************************************************************************
 * Core OPL3 register write.  Delegates to adapter common for bank-
 * coordinated access, then updates the shadow register.
 *
 * Called at DISPATCH_LEVEL within spinlock.
 */
#pragma code_seg()
void
CMiniportMidiFMAdLibGold::
SoundMidiSendFM
(
    ULONG   Address,
    UCHAR   Data
)
{
    ASSERT(Address < 0x200);
    ASSERT(KeGetCurrentIrql() == DISPATCH_LEVEL);

    _DbgPrintF(DEBUGLVL_VERBOSE, ("%X\t%X", Address, Data));

    m_AdapterCommon->WriteOPL3(Address, Data);
    m_SavedRegValues[Address] = Data;
}


/*****************************************************************************
 * CMiniportMidiFMAdLibGold::Opl3_BoardReset()
 *****************************************************************************
 * Silence and reset the OPL3 chip.  Sets the NEW bit to enable OPL3 mode
 * with stereo output (Ad Lib Gold-specific addition to the DDK pattern).
 */
#pragma code_seg()
void
CMiniportMidiFMAdLibGold::
Opl3_BoardReset()
{
    ASSERT(KeGetCurrentIrql() == DISPATCH_LEVEL);

    BYTE i;

    _DbgPrintF(DEBUGLVL_VERBOSE, ("Opl3_BoardReset"));

    /* Enable OPL3 mode (stereo, 18 voices, extra waveforms) */
    SoundMidiSendFM(AD_NEW, 0x01);
    SoundMidiSendFM(AD_MASK, 0x60);
    SoundMidiSendFM(AD_CONNECTION, 0x00);
    SoundMidiSendFM(AD_NTS, 0x00);

    /* Turn off drums, use high vibrato/modulation */
    SoundMidiSendFM(AD_DRUM, 0xc0);

    /* Turn off all oscillators (max attenuation) */
    for (i = 0; i <= 0x15; i++)
    {
        if ((i & 0x07) <= 0x05)
        {
            SoundMidiSendFM(AD_LEVEL + i, 0x3f);
            SoundMidiSendFM(AD_LEVEL2 + i, 0x3f);
        }
    }

    /* Turn off all voices and set stereo output to both channels */
    for (i = 0; i <= 0x08; i++)
    {
        SoundMidiSendFM(AD_BLOCK + i, 0x00);
        SoundMidiSendFM(AD_BLOCK2 + i, 0x00);

        /* Set STL + STR bits (D5 + D4) for stereo output on all voices */
        SoundMidiSendFM(AD_FEEDBACK + i, 0x30);
        SoundMidiSendFM(AD_FEEDBACK2 + i, 0x30);
    }
}


/*****************************************************************************
 * CMiniportMidiFMAdLibGold::MiniportMidiFMResume()
 *****************************************************************************
 * Restores all OPL3 registers from shadow on power resume.
 */
#pragma code_seg()
void
CMiniportMidiFMAdLibGold::
MiniportMidiFMResume()
{
    KIRQL oldIrql;
    BYTE  i;

    _DbgPrintF(DEBUGLVL_VERBOSE, ("MiniportMidiFMResume"));
    KeAcquireSpinLock(&m_SpinLock, &oldIrql);

    SoundMidiSendFM(AD_LSI, m_SavedRegValues[AD_LSI]);
    SoundMidiSendFM(AD_LSI2, m_SavedRegValues[AD_LSI2]);
    SoundMidiSendFM(AD_TIMER1, m_SavedRegValues[AD_TIMER1]);
    SoundMidiSendFM(AD_TIMER2, m_SavedRegValues[AD_TIMER2]);
    SoundMidiSendFM(AD_MASK, m_SavedRegValues[AD_MASK]);
    SoundMidiSendFM(AD_CONNECTION, m_SavedRegValues[AD_CONNECTION]);
    SoundMidiSendFM(AD_NEW, m_SavedRegValues[AD_NEW]);
    SoundMidiSendFM(AD_NTS, m_SavedRegValues[AD_NTS]);
    SoundMidiSendFM(AD_DRUM, m_SavedRegValues[AD_DRUM]);

    for (i = 0; i <= 0x15; i++)
    {
        if ((i & 0x07) <= 0x05)
        {
            SoundMidiSendFM(AD_MULT + i, m_SavedRegValues[AD_MULT + i]);
            SoundMidiSendFM(AD_MULT2 + i, m_SavedRegValues[AD_MULT2 + i]);
            SoundMidiSendFM(AD_LEVEL + i, m_SavedRegValues[AD_LEVEL + i]);
            SoundMidiSendFM(AD_LEVEL2 + i, m_SavedRegValues[AD_LEVEL2 + i]);
            SoundMidiSendFM(AD_AD + i, m_SavedRegValues[AD_AD + i]);
            SoundMidiSendFM(AD_AD2 + i, m_SavedRegValues[AD_AD2 + i]);
            SoundMidiSendFM(AD_SR + i, m_SavedRegValues[AD_SR + i]);
            SoundMidiSendFM(AD_SR2 + i, m_SavedRegValues[AD_SR2 + i]);
            SoundMidiSendFM(AD_WAVE + i, m_SavedRegValues[AD_WAVE + i]);
            SoundMidiSendFM(AD_WAVE2 + i, m_SavedRegValues[AD_WAVE2 + i]);
        }
    }

    for (i = 0; i <= 0x08; i++)
    {
        SoundMidiSendFM(AD_FNUMBER + i, m_SavedRegValues[AD_FNUMBER + i]);
        SoundMidiSendFM(AD_FNUMBER2 + i, m_SavedRegValues[AD_FNUMBER2 + i]);
        SoundMidiSendFM(AD_FEEDBACK + i, m_SavedRegValues[AD_FEEDBACK + i]);
        SoundMidiSendFM(AD_FEEDBACK2 + i, m_SavedRegValues[AD_FEEDBACK2 + i]);
        SoundMidiSendFM(AD_BLOCK + i, m_SavedRegValues[AD_BLOCK + i]);
        SoundMidiSendFM(AD_BLOCK2 + i, m_SavedRegValues[AD_BLOCK2 + i]);
    }

    KeReleaseSpinLock(&m_SpinLock, oldIrql);
}


/* ========================================================================= */
/* Stream class methods                                                      */
/* ========================================================================= */


/*****************************************************************************
 * CMiniportMidiStreamFMAdLibGold::NonDelegatingQueryInterface()
 */
#pragma code_seg("PAGE")
STDMETHODIMP
CMiniportMidiStreamFMAdLibGold::
NonDelegatingQueryInterface
(
    REFIID  Interface,
    PVOID * Object
)
{
    PAGED_CODE();
    ASSERT(Object);

    if (IsEqualGUIDAligned(Interface, IID_IUnknown))
    {
        *Object = PVOID(PUNKNOWN(PMINIPORTMIDISTREAM(this)));
    }
    else if (IsEqualGUIDAligned(Interface, IID_IMiniportMidiStream))
    {
        *Object = PVOID(PMINIPORTMIDISTREAM(this));
    }
    else
    {
        *Object = NULL;
    }

    if (*Object)
    {
        PUNKNOWN(*Object)->AddRef();
        return STATUS_SUCCESS;
    }

    return STATUS_INVALID_PARAMETER;
}


/*****************************************************************************
 * CMiniportMidiStreamFMAdLibGold::~CMiniportMidiStreamFMAdLibGold()
 */
#pragma code_seg("PAGE")
CMiniportMidiStreamFMAdLibGold::
~CMiniportMidiStreamFMAdLibGold
(   void
)
{
    PAGED_CODE();

    _DbgPrintF(DEBUGLVL_VERBOSE, ("~CMiniportMidiStreamFMAdLibGold"));

    Opl3_AllNotesOff();

    if (m_Miniport)
    {
        m_Miniport->m_fStreamExists = FALSE;
        m_Miniport->Release();
    }
}


/*****************************************************************************
 * CMiniportMidiStreamFMAdLibGold::Init()
 */
#pragma code_seg("PAGE")
NTSTATUS
CMiniportMidiStreamFMAdLibGold::
Init
(
    IN      CMiniportMidiFMAdLibGold *  Miniport
)
{
    PAGED_CODE();
    ASSERT(Miniport);

    int i;

    _DbgPrintF(DEBUGLVL_VERBOSE, ("CMiniportMidiStreamFMAdLibGold::Init"));

    m_Miniport = Miniport;
    m_Miniport->AddRef();

    m_dwCurTime = 1;

    /* Synth-level attenuation = 0 (topology handles FM volume) */
    m_wSynthAttenL = 0;
    m_wSynthAttenR = 0;

    /* Start channel attenuations at -3 dB (MIDI level ~90) */
    for (i = 0; i < NUMCHANNELS; i++)
    {
        m_bChanAtten[i] = 4;
        m_bStereoMask[i] = 0xff;
    }

    return STATUS_SUCCESS;
}


/*****************************************************************************
 * CMiniportMidiStreamFMAdLibGold::SetState()
 */
#pragma code_seg("PAGE")
STDMETHODIMP
CMiniportMidiStreamFMAdLibGold::
SetState
(
    IN      KSSTATE     NewState
)
{
    PAGED_CODE();

    switch (NewState)
    {
    case KSSTATE_STOP:
    case KSSTATE_ACQUIRE:
    case KSSTATE_PAUSE:
        Opl3_AllNotesOff();
        break;

    case KSSTATE_RUN:
        break;
    }

    return STATUS_SUCCESS;
}


/*****************************************************************************
 * CMiniportMidiStreamFMAdLibGold::SetFormat()
 */
#pragma code_seg("PAGE")
STDMETHODIMP
CMiniportMidiStreamFMAdLibGold::
SetFormat
(
    IN      PKSDATAFORMAT   Format
)
{
    PAGED_CODE();
    return STATUS_SUCCESS;
}


/*****************************************************************************
 * CMiniportMidiStreamFMAdLibGold::Read()
 *****************************************************************************
 * FM synth is output-only; read is not implemented.
 */
#pragma code_seg()
STDMETHODIMP
CMiniportMidiStreamFMAdLibGold::
Read
(
    IN      PVOID   BufferAddress,
    IN      ULONG   Length,
    OUT     PULONG  BytesRead
)
{
    return STATUS_NOT_IMPLEMENTED;
}


/*****************************************************************************
 * CMiniportMidiStreamFMAdLibGold::Write()
 *****************************************************************************
 * Receives a single MIDI message and dispatches it to WriteMidiData.
 */
#pragma code_seg()
STDMETHODIMP
CMiniportMidiStreamFMAdLibGold::
Write
(
    IN      PVOID   BufferAddress,
    IN      ULONG   Length,
    OUT     PULONG  BytesWritten
)
{
    ASSERT(BufferAddress);
    ASSERT(BytesWritten);

    BYTE statusByte = *(PBYTE)BufferAddress & 0xF0;
    *BytesWritten = Length;

    if (statusByte < 0x80)
    {
        _DbgPrintF(DEBUGLVL_TERSE, ("Write: first byte must be status -- ignored"));
    }
    else if (statusByte == 0xF0)
    {
        /* System messages not handled */
    }
    else if (statusByte == 0xA0)
    {
        /* Polyphonic key pressure not handled */
    }
    else if (statusByte == 0xD0)
    {
        /* Channel pressure not handled */
    }
    else if (Length < 4)
    {
        WriteMidiData(*(DWORD *)BufferAddress);
    }
    else
    {
        _DbgPrintF(DEBUGLVL_TERSE, ("Write: length > 3 not handled"));
    }
    return STATUS_SUCCESS;
}


/* ========================================================================= */
/* Private Opl3 processing methods                                           */
/* ========================================================================= */


#pragma code_seg()
void
CMiniportMidiStreamFMAdLibGold::
WriteMidiData(DWORD dwData)
{
    BYTE    bMsgType, bChannel, bVelocity, bNote;
    WORD    wTemp;
    KIRQL   oldIrql;

    bMsgType  = (BYTE) dwData & (BYTE)0xf0;
    bChannel  = (BYTE) dwData & (BYTE)0x0f;
    bNote     = (BYTE) ((WORD) dwData >> 8) & (BYTE)0x7f;
    bVelocity = (BYTE) (dwData >> 16) & (BYTE)0x7f;

    _DbgPrintF(DEBUGLVL_VERBOSE, ("WriteMidiData: (%x %x %x)",
        bMsgType + bChannel, bNote, bVelocity));

    KeAcquireSpinLock(&m_Miniport->m_SpinLock, &oldIrql);
    switch (bMsgType)
    {
    case 0x90:
        if (bVelocity)
        {
            if (bChannel == DRUMCHANNEL)
            {
                Opl3_NoteOn((BYTE)(bNote + 128), bNote, bChannel,
                            bVelocity, (short)m_iBend[bChannel]);
            }
            else
            {
                Opl3_NoteOn((BYTE)m_bPatch[bChannel], bNote, bChannel,
                            bVelocity, (short)m_iBend[bChannel]);
            }
            break;
        }
        /* fall through to note off if velocity == 0 */

    case 0x80:
        if (bChannel == DRUMCHANNEL)
        {
            Opl3_NoteOff((BYTE)(bNote + 128), bNote, bChannel, 0);
        }
        else
        {
            Opl3_NoteOff((BYTE)m_bPatch[bChannel], bNote, bChannel,
                         m_bSustain[bChannel]);
        }
        break;

    case 0xb0:
        switch (bNote)
        {
        case 7:
            Opl3_ChannelVolume(bChannel, gbVelocityAtten[bVelocity >> 1]);
            break;

        case 8:
        case 10:
            Opl3_SetPan(bChannel, bVelocity);
            break;

        case 64:
            Opl3_SetSustain(bChannel, bVelocity);
            break;

        default:
            if (bNote >= 120)
            {
                Opl3_ChannelNotesOff(bChannel);
            }
            break;
        }
        break;

    case 0xc0:
        if (bChannel != DRUMCHANNEL)
        {
            m_bPatch[bChannel] = bNote;
        }
        break;

    case 0xe0:
        wTemp = ((WORD)bVelocity << 9) | ((WORD)bNote << 2);
        m_iBend[bChannel] = (short)(WORD)(wTemp + 0x8000);
        Opl3_PitchBend(bChannel, m_iBend[bChannel]);
        break;
    }
    KeReleaseSpinLock(&m_Miniport->m_SpinLock, oldIrql);
}


#pragma code_seg()
void
CMiniportMidiStreamFMAdLibGold::
Opl3_AllNotesOff()
{
    BYTE  i;
    KIRQL oldIrql;

    KeAcquireSpinLock(&m_Miniport->m_SpinLock, &oldIrql);
    for (i = 0; i < NUM2VOICES; i++)
    {
        Opl3_NoteOff(m_Voice[i].bPatch, m_Voice[i].bNote,
                     m_Voice[i].bChannel, 0);
    }
    KeReleaseSpinLock(&m_Miniport->m_SpinLock, oldIrql);
}


#pragma code_seg()
void
CMiniportMidiStreamFMAdLibGold::
Opl3_NoteOff
(
    BYTE    bPatch,
    BYTE    bNote,
    BYTE    bChannel,
    BYTE    bSustain
)
{
    ASSERT(KeGetCurrentIrql() == DISPATCH_LEVEL);

    WORD wOffset, wTemp;

    wTemp = Opl3_FindFullSlot(bNote, bChannel);

    if (wTemp != 0xffff)
    {
        if (bSustain)
        {
            m_Voice[wTemp].bSusHeld = 1;
            return;
        }

        wOffset = wTemp;
        if (wTemp >= (NUM2VOICES / 2))
            wOffset += (0x100 - (NUM2VOICES / 2));

        m_Miniport->SoundMidiSendFM(AD_BLOCK + wOffset,
            (BYTE)(m_Voice[wTemp].bBlock[0] & 0x1f));

        m_Voice[wTemp].bOn = FALSE;
        m_Voice[wTemp].bBlock[0] &= 0x1f;
        m_Voice[wTemp].bBlock[1] &= 0x1f;
        m_Voice[wTemp].dwTime = m_dwCurTime;
    }
}


#pragma code_seg()
WORD
CMiniportMidiStreamFMAdLibGold::
Opl3_FindFullSlot
(
    BYTE    bNote,
    BYTE    bChannel
)
{
    ASSERT(KeGetCurrentIrql() == DISPATCH_LEVEL);

    WORD i;

    for (i = 0; i < NUM2VOICES; i++)
    {
        if ((bChannel == m_Voice[i].bChannel)
            && (bNote == m_Voice[i].bNote)
            && (m_Voice[i].bOn))
        {
            return i;
        }
    }
    return 0xFFFF;
}


#pragma code_seg()
void
CMiniportMidiStreamFMAdLibGold::
Opl3_FMNote
(
    WORD                wNote,
    noteStruct FAR *    lpSN
)
{
    ASSERT(KeGetCurrentIrql() == DISPATCH_LEVEL);

    WORD            i;
    WORD            wOffset;
    operStruct FAR  *lpOS;

    /* Write note off first */
    wOffset = wNote;
    if (wNote >= (NUM2VOICES / 2))
        wOffset += (0x100 - (NUM2VOICES / 2));

    m_Miniport->SoundMidiSendFM(AD_BLOCK + wOffset, 0);

    /* Write operator registers */
    for (i = 0; i < 2; i++)
    {
        lpOS = &lpSN->op[i];
        wOffset = gw2OpOffset[wNote][i];
        m_Miniport->SoundMidiSendFM(0x20 + wOffset, lpOS->bAt20);
        m_Miniport->SoundMidiSendFM(0x40 + wOffset, lpOS->bAt40);
        m_Miniport->SoundMidiSendFM(0x60 + wOffset, lpOS->bAt60);
        m_Miniport->SoundMidiSendFM(0x80 + wOffset, lpOS->bAt80);
        m_Miniport->SoundMidiSendFM(0xE0 + wOffset, lpOS->bAtE0);
    }

    /* Write voice registers */
    wOffset = (wNote < 9) ? wNote : (wNote + 0x100 - 9);
    m_Miniport->SoundMidiSendFM(0xa0 + wOffset, lpSN->bAtA0[0]);
    m_Miniport->SoundMidiSendFM(0xc0 + wOffset, lpSN->bAtC0[0]);

    /* Note on */
    m_Miniport->SoundMidiSendFM(0xb0 + wOffset,
        (BYTE)(lpSN->bAtB0[0] | 0x20));
}


#pragma code_seg()
void
CMiniportMidiStreamFMAdLibGold::
Opl3_NoteOn
(
    BYTE    bPatch,
    BYTE    bNote,
    BYTE    bChannel,
    BYTE    bVelocity,
    short   iBend
)
{
    ASSERT(KeGetCurrentIrql() == DISPATCH_LEVEL);

    WORD             wTemp, i, j;
    BYTE             b4Op, bTemp, bMode, bStereo;
    patchStruct FAR  *lpPS;
    DWORD            dwBasicPitch, dwPitch[2];
    noteStruct       NS;

    lpPS = glpPatch + bPatch;

    dwBasicPitch = gdwPitch[bNote % 12];
    bTemp = bNote / (BYTE)12;
    if (bTemp > (BYTE)(60 / 12))
        dwBasicPitch = AsLSHL(dwBasicPitch, (BYTE)(bTemp - (BYTE)(60 / 12)));
    else if (bTemp < (BYTE)(60 / 12))
        dwBasicPitch = AsULSHR(dwBasicPitch, (BYTE)((BYTE)(60 / 12) - bTemp));

    RtlCopyMemory((LPSTR)&NS, (LPSTR)&lpPS->note, sizeof(noteStruct));
    b4Op = (BYTE)(NS.bOp != PATCH_1_2OP);

    for (j = 0; j < 2; j++)
    {
        dwPitch[j] = dwBasicPitch;
        bTemp = (BYTE)((NS.bAtB0[j] >> 2) & 0x07);
        if (bTemp > 4)
            dwPitch[j] = AsLSHL(dwPitch[j], (BYTE)(bTemp - (BYTE)4));
        else if (bTemp < 4)
            dwPitch[j] = AsULSHR(dwPitch[j], (BYTE)((BYTE)4 - bTemp));

        wTemp = Opl3_CalcFAndB(Opl3_CalcBend(dwPitch[j], iBend));
        NS.bAtA0[j] = (BYTE)wTemp;
        NS.bAtB0[j] = (BYTE)0x20 | (BYTE)(wTemp >> 8);
    }

    bMode = (BYTE)((NS.bAtC0[0] & 0x01) * 2 + 4);

    for (i = 0; i < 2; i++)
    {
        wTemp = (BYTE)Opl3_CalcVolume(
            (BYTE)(NS.op[i].bAt40 & (BYTE)0x3f),
            bChannel, bVelocity, (BYTE)i, bMode);
        NS.op[i].bAt40 = (NS.op[i].bAt40 & (BYTE)0xc0) | (BYTE)wTemp;
    }

    bStereo = Opl3_CalcStereoMask(bChannel);
    NS.bAtC0[0] &= bStereo;

    wTemp = Opl3_FindEmptySlot(bPatch);

    Opl3_FMNote(wTemp, &NS);
    m_Voice[wTemp].bNote = bNote;
    m_Voice[wTemp].bChannel = bChannel;
    m_Voice[wTemp].bPatch = bPatch;
    m_Voice[wTemp].bVelocity = bVelocity;
    m_Voice[wTemp].bOn = TRUE;
    m_Voice[wTemp].dwTime = m_dwCurTime++;
    m_Voice[wTemp].dwOrigPitch[0] = dwPitch[0];
    m_Voice[wTemp].dwOrigPitch[1] = dwPitch[1];
    m_Voice[wTemp].bBlock[0] = NS.bAtB0[0];
    m_Voice[wTemp].bBlock[1] = NS.bAtB0[1];
    m_Voice[wTemp].bSusHeld = 0;
}


#pragma code_seg()
WORD
CMiniportMidiStreamFMAdLibGold::
Opl3_CalcFAndB(DWORD dwPitch)
{
    ASSERT(KeGetCurrentIrql() == DISPATCH_LEVEL);

    BYTE bBlock;

    for (bBlock = 1; dwPitch >= 0x400; dwPitch >>= 1, bBlock++)
        ;

    if (bBlock > 0x07)
        bBlock = 0x07;

    return ((WORD)bBlock << 10) | (WORD)dwPitch;
}


#pragma code_seg()
DWORD
CMiniportMidiStreamFMAdLibGold::
Opl3_CalcBend(DWORD dwOrig, short iBend)
{
    ASSERT(KeGetCurrentIrql() == DISPATCH_LEVEL);

    DWORD dw;

    if (iBend > 0)
    {
        dw = (DWORD)((iBend * (LONG)(256.0 * (EQUAL * EQUAL - 1.0))) >> 8);
        dwOrig += (DWORD)(AsULMUL(dw, dwOrig) >> 15);
    }
    else if (iBend < 0)
    {
        dw = (DWORD)(((-iBend) * (LONG)(256.0 * (1.0 - 1.0 / EQUAL / EQUAL))) >> 8);
        dwOrig -= (DWORD)(AsULMUL(dw, dwOrig) >> 15);
    }

    return dwOrig;
}


#pragma code_seg()
BYTE
CMiniportMidiStreamFMAdLibGold::
Opl3_CalcVolume(BYTE bOrigAtten, BYTE bChannel, BYTE bVelocity,
                BYTE bOper, BYTE bMode)
{
    ASSERT(KeGetCurrentIrql() == DISPATCH_LEVEL);

    BYTE bVolume;
    WORD wTemp;
    WORD wMin;

    switch (bMode)
    {
    case 0:  bVolume = (BYTE)(bOper == 3); break;
    case 1:  bVolume = (BYTE)((bOper == 1) || (bOper == 3)); break;
    case 2:  bVolume = (BYTE)((bOper == 0) || (bOper == 3)); break;
    case 3:  bVolume = (BYTE)(bOper != 1); break;
    case 4:  bVolume = (BYTE)((bOper == 1) || (bOper == 3)); break;
    case 5:  bVolume = (BYTE)(bOper >= 1); break;
    case 6:  bVolume = (BYTE)(bOper <= 2); break;
    case 7:  bVolume = TRUE; break;
    default: bVolume = FALSE; break;
    }

    if (!bVolume)
        return bOrigAtten;

    wMin = (m_wSynthAttenL < m_wSynthAttenR) ? m_wSynthAttenL : m_wSynthAttenR;
    wTemp = bOrigAtten +
            ((wMin << 1) +
            m_bChanAtten[bChannel] +
            gbVelocityAtten[bVelocity >> 1]);
    return (wTemp > 0x3f) ? (BYTE)0x3f : (BYTE)wTemp;
}


#pragma code_seg()
void
CMiniportMidiStreamFMAdLibGold::
Opl3_ChannelNotesOff(BYTE bChannel)
{
    ASSERT(KeGetCurrentIrql() == DISPATCH_LEVEL);

    int i;

    for (i = 0; i < NUM2VOICES; i++)
    {
        if ((m_Voice[i].bOn) && (m_Voice[i].bChannel == bChannel))
        {
            Opl3_NoteOff(m_Voice[i].bPatch, m_Voice[i].bNote,
                         m_Voice[i].bChannel, 0);
        }
    }
}


#pragma code_seg()
void
CMiniportMidiStreamFMAdLibGold::
Opl3_ChannelVolume(BYTE bChannel, WORD wAtten)
{
    ASSERT(KeGetCurrentIrql() == DISPATCH_LEVEL);

    m_bChanAtten[bChannel] = (BYTE)wAtten;
    Opl3_SetVolume(bChannel);
}


#pragma code_seg()
void
CMiniportMidiStreamFMAdLibGold::
Opl3_SetVolume
(
    BYTE   bChannel
)
{
    ASSERT(KeGetCurrentIrql() == DISPATCH_LEVEL);

    WORD            i, j, wTemp, wOffset;
    noteStruct FAR  *lpPS;
    BYTE            bMode, bStereo;

    if (!glpPatch)
        return;

    for (i = 0; i < NUM2VOICES; i++)
    {
        if ((m_Voice[i].bChannel == bChannel) || (bChannel == 0xff))
        {
            lpPS = &(glpPatch + m_Voice[i].bPatch)->note;

            bMode = (BYTE)((lpPS->bAtC0[0] & 0x01) * 2 + 4);

            for (j = 0; j < 2; j++)
            {
                wTemp = (BYTE)Opl3_CalcVolume(
                    (BYTE)(lpPS->op[j].bAt40 & (BYTE)0x3f),
                    m_Voice[i].bChannel, m_Voice[i].bVelocity,
                    (BYTE)j, bMode);

                wOffset = gw2OpOffset[i][j];
                m_Miniport->SoundMidiSendFM(
                    0x40 + wOffset,
                    (BYTE)((lpPS->op[j].bAt40 & (BYTE)0xc0) | (BYTE)wTemp));
            }

            bStereo = Opl3_CalcStereoMask(m_Voice[i].bChannel);
            wOffset = i;
            if (i >= (NUM2VOICES / 2))
                wOffset += (0x100 - (NUM2VOICES / 2));
            m_Miniport->SoundMidiSendFM(0xc0 + wOffset,
                (BYTE)(lpPS->bAtC0[0] & bStereo));
        }
    }
}


#pragma code_seg()
void
CMiniportMidiStreamFMAdLibGold::
Opl3_SetPan(BYTE bChannel, BYTE bPan)
{
    ASSERT(KeGetCurrentIrql() == DISPATCH_LEVEL);

    if (bPan > (64 + 16))
        m_bStereoMask[bChannel] = 0xef;
    else if (bPan < (64 - 16))
        m_bStereoMask[bChannel] = 0xdf;
    else
        m_bStereoMask[bChannel] = 0xff;

    Opl3_SetVolume(bChannel);
}


#pragma code_seg()
void
CMiniportMidiStreamFMAdLibGold::
Opl3_PitchBend
(
    BYTE    bChannel,
    short   iBend
)
{
    ASSERT(KeGetCurrentIrql() == DISPATCH_LEVEL);

    WORD  i, wTemp[2], wOffset, j;
    DWORD dwNew;

    m_iBend[bChannel] = iBend;

    for (i = 0; i < NUM2VOICES; i++)
    {
        if (m_Voice[i].bChannel == bChannel)
        {
            j = 0;
            dwNew = Opl3_CalcBend(m_Voice[i].dwOrigPitch[j], iBend);
            wTemp[j] = Opl3_CalcFAndB(dwNew);
            m_Voice[i].bBlock[j] =
                (m_Voice[i].bBlock[j] & (BYTE)0xe0) |
                (BYTE)(wTemp[j] >> 8);

            wOffset = i;
            if (i >= (NUM2VOICES / 2))
                wOffset += (0x100 - (NUM2VOICES / 2));

            m_Miniport->SoundMidiSendFM(AD_BLOCK + wOffset,
                m_Voice[i].bBlock[0]);
            m_Miniport->SoundMidiSendFM(AD_FNUMBER + wOffset,
                (BYTE)wTemp[0]);
        }
    }
}


#pragma code_seg()
BYTE
CMiniportMidiStreamFMAdLibGold::
Opl3_CalcStereoMask(BYTE bChannel)
{
    ASSERT(KeGetCurrentIrql() == DISPATCH_LEVEL);

    WORD wLeft, wRight;

    wLeft = (m_wSynthAttenL << 1) + m_bChanAtten[bChannel];
    wRight = (m_wSynthAttenR << 1) + m_bChanAtten[bChannel];

    if ((wLeft > 0x3f) && (wRight > 0x3f))
        return 0xcf;

    if ((wLeft + 8) < wRight)
        return (BYTE)(0xef & m_bStereoMask[bChannel]);
    else if ((wRight + 8) < wLeft)
        return (BYTE)(0xdf & m_bStereoMask[bChannel]);
    else
        return (BYTE)(m_bStereoMask[bChannel]);
}


#pragma code_seg()
WORD
CMiniportMidiStreamFMAdLibGold::
Opl3_FindEmptySlot(BYTE bPatch)
{
    ASSERT(KeGetCurrentIrql() == DISPATCH_LEVEL);

    WORD  i, found;
    DWORD dwOldest;

    for (i = 0; i < NUM2VOICES; i++)
    {
        if (!m_Voice[i].dwTime)
            return i;
    }

    dwOldest = 0xffffffff;
    found = 0xffff;
    for (i = 0; i < NUM2VOICES; i++)
    {
        if (!m_Voice[i].bOn && (m_Voice[i].dwTime < dwOldest))
        {
            dwOldest = m_Voice[i].dwTime;
            found = i;
        }
    }
    if (found != 0xffff)
        return found;

    dwOldest = 0xffffffff;
    found = 0xffff;
    for (i = 0; i < NUM2VOICES; i++)
    {
        if ((m_Voice[i].bPatch == bPatch) && (m_Voice[i].dwTime < dwOldest))
        {
            dwOldest = m_Voice[i].dwTime;
            found = i;
        }
    }
    if (found != 0xffff)
        return found;

    found = 0;
    dwOldest = m_Voice[found].dwTime;
    for (i = (found + 1); i < NUM2VOICES; i++)
    {
        if (m_Voice[i].dwTime < dwOldest)
        {
            dwOldest = m_Voice[i].dwTime;
            found = i;
        }
    }

    return found;
}


#pragma code_seg()
void
CMiniportMidiStreamFMAdLibGold::
Opl3_SetSustain(BYTE bChannel, BYTE bSusLevel)
{
    ASSERT(KeGetCurrentIrql() == DISPATCH_LEVEL);

    WORD i;

    if (m_bSustain[bChannel] && !bSusLevel)
    {
        for (i = 0; i < NUM2VOICES; i++)
        {
            if ((bChannel == m_Voice[i].bChannel) && m_Voice[i].bSusHeld)
            {
                Opl3_NoteOff(m_Voice[i].bPatch, m_Voice[i].bNote,
                             m_Voice[i].bChannel, 0);
            }
        }
    }
    m_bSustain[bChannel] = bSusLevel;
}
